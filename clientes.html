<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <button id="logout">Cerrar Sesión</button>

    <div class="container">
        <!-- Tabla de Clientes -->
        <div class="table-container">
            <h2>Clientes</h2>
            <table id="clientes-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Teléfono</th>
                        <th>Correo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientes-body">
                    <!-- Datos dinámicos aquí -->
                </tbody>
            </table>
        </div>

        <!-- Formulario de Cliente -->
        <div class="form-container">
            <h2>Datos del Cliente</h2>
            <form id="cliente-form">
                <input type="hidden" id="cliente-id">
                <label>Nombre:</label>
                <input type="text" id="cliente-nombre" required>
                
                <label>Dirección:</label>
                <input type="text" id="cliente-direccion" required>
                
                <label>Teléfono:</label>
                <input type="text" id="cliente-telefono" required>
                
                <label>Correo:</label>
                <input type="email" id="cliente-correo" required>
                
                <label>Tarifa Inicial:</label>
                <input type="number" id="cliente-tarifa" required>
                
                <label>Mensualidad:</label>
                <input type="number" id="cliente-mensualidad" required>
                
                <label>Código Postal:</label>
                <input type="text" id="cliente-codigo" required>
                
                <label>Plagas Encontradas:</label>
                <input type="text" id="cliente-plagas" required>
                
                <label>Zona:</label>
                <input type="text" id="cliente-zona" required>

                <div class="form-buttons">
                    <button type="button" id="add-btn">Agregar</button>
                    <button type="button" id="update-btn">Actualizar</button>
                    <button type="button" id="delete-btn">Eliminar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://empresa-fumigacion-latest.onrender.com/api/v1";
        const token = localStorage.getItem("token");

        if (!token) {
            window.location.href = "login.html"; 
        }

        async function cargarClientes() {
            const response = await fetch(`${API_URL}/clientes/all`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            const clientes = await response.json();
            const tbody = document.getElementById("clientes-body");
            tbody.innerHTML = "";

            clientes.forEach(cliente => {
                const row = `
                    <tr onclick="seleccionarCliente(${cliente.id})">
                        <td>${cliente.id}</td>
                        <td>${cliente.nombre}</td>
                        <td>${cliente.telefono}</td>
                        <td>${cliente.correo}</td>
                        <td>
                            <button class="edit-btn">✏️</button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        function seleccionarCliente(id) {
            fetch(`${API_URL}/clientes/${id}`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(cliente => {
                document.getElementById("cliente-id").value = cliente.id;
                document.getElementById("cliente-nombre").value = cliente.nombre;
                document.getElementById("cliente-direccion").value = cliente.direccion;
                document.getElementById("cliente-telefono").value = cliente.telefono;
                document.getElementById("cliente-correo").value = cliente.correo;
                document.getElementById("cliente-tarifa").value = cliente.tarifaInicial;
                document.getElementById("cliente-mensualidad").value = cliente.mensualidad;
                document.getElementById("cliente-codigo").value = cliente.codigoPostal;
                document.getElementById("cliente-plagas").value = cliente.plagasEncontradas;
                document.getElementById("cliente-zona").value = cliente.zona;
            });
        }

        async function agregarCliente() {
            const cliente = obtenerDatosFormulario();
            await fetch(`${API_URL}/clientes`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify(cliente)
            });
            cargarClientes();
        }

        async function actualizarCliente() {
            const id = document.getElementById("cliente-id").value;
            const cliente = obtenerDatosFormulario();
            await fetch(`${API_URL}/clientes/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify(cliente)
            });
            cargarClientes();
        }

        async function eliminarCliente() {
            const id = document.getElementById("cliente-id").value;
            if (confirm("¿Estás seguro de eliminar este cliente?")) {
                await fetch(`${API_URL}/clientes/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                cargarClientes();
                document.getElementById("cliente-form").reset();
            }
        }

        function obtenerDatosFormulario() {
            return {
                nombre: document.getElementById("cliente-nombre").value,
                direccion: document.getElementById("cliente-direccion").value,
                telefono: document.getElementById("cliente-telefono").value,
                correo: document.getElementById("cliente-correo").value,
                tarifaInicial: document.getElementById("cliente-tarifa").value,
                mensualidad: document.getElementById("cliente-mensualidad").value,
                codigoPostal: document.getElementById("cliente-codigo").value,
                plagasEncontradas: document.getElementById("cliente-plagas").value,
                zona: document.getElementById("cliente-zona").value
            };
        }

        document.getElementById("add-btn").addEventListener("click", agregarCliente);
        document.getElementById("update-btn").addEventListener("click", actualizarCliente);
        document.getElementById("delete-btn").addEventListener("click", eliminarCliente);
        document.getElementById("logout").addEventListener("click", () => {
            localStorage.removeItem("token");
            window.location.href = "login.html";
        });

        cargarClientes();
    </script>

</body>
</html>
