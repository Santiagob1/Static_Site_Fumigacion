<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Clientes</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="crud-container">
        <h2>Gesti√≥n de Clientes</h2>
        <button id="logout">Cerrar Sesi√≥n</button>
        <button id="add-client">‚ûï Agregar Cliente</button>
        <table id="clientes-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Direcci√≥n</th>
                    <th>Tel√©fono</th>
                    <th>Correo</th>
                    <th>Tarifa Inicial</th>
                    <th>Mensualidad</th>
                    <th>C√≥digo Postal</th>
                    <th>Plagas Encontradas</th>
                    <th>Zona</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="clientes-body">
                <!-- Datos din√°micos aqu√≠ -->
            </tbody>
        </table>
    </div>

    <!-- Modal para Editar Cliente -->
    <div id="edit-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Editar Cliente</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <input type="text" id="edit-nombre" required placeholder="Nombre">
                <input type="text" id="edit-direccion" required placeholder="Direcci√≥n">
                <input type="text" id="edit-telefono" required placeholder="Tel√©fono">
                <input type="email" id="edit-correo" required placeholder="Correo">
                <input type="number" id="edit-tarifa" required placeholder="Tarifa Inicial">
                <input type="number" id="edit-mensualidad" required placeholder="Mensualidad">
                <input type="text" id="edit-codigo" required placeholder="C√≥digo Postal">
                <input type="text" id="edit-plagas" required placeholder="Plagas Encontradas">
                <input type="text" id="edit-zona" required placeholder="Zona">
                <button type="submit">Guardar Cambios</button>
                <button type="button" id="close-edit">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://empresa-fumigacion-latest.onrender.com/api/v1";
        const token = localStorage.getItem("token");

        if (!token) {
            window.location.href = "login.html"; 
        }

        async function cargarClientes() {
            const response = await fetch(`${API_URL}/clientes/all`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            const clientes = await response.json();
            const tbody = document.getElementById("clientes-body");
            tbody.innerHTML = "";

            clientes.forEach(cliente => {
                const row = `
                    <tr>
                        <td>${cliente.id}</td>
                        <td>${cliente.nombre}</td>
                        <td>${cliente.direccion}</td>
                        <td>${cliente.telefono}</td>
                        <td>${cliente.correo}</td>
                        <td>${cliente.tarifaInicial}</td>
                        <td>${cliente.mensualidad}</td>
                        <td>${cliente.codigoPostal}</td>
                        <td>${cliente.plagasEncontradas}</td>
                        <td>${cliente.zona}</td>
                        <td>
                            <button class="edit-btn" onclick="editarCliente(${cliente.id})">‚úèÔ∏è</button>
                            <button class="delete-btn" onclick="eliminarCliente(${cliente.id})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function eliminarCliente(id) {
            if (confirm("¬øEst√°s seguro de eliminar este cliente?")) {
                await fetch(`${API_URL}/clientes/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                cargarClientes();
            }
        }

        function editarCliente(id) {
            document.getElementById("edit-modal").classList.remove("hidden");

            fetch(`${API_URL}/clientes/${id}`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(cliente => {
                document.getElementById("edit-id").value = cliente.id;
                document.getElementById("edit-nombre").value = cliente.nombre;
                document.getElementById("edit-direccion").value = cliente.direccion;
                document.getElementById("edit-telefono").value = cliente.telefono;
                document.getElementById("edit-correo").value = cliente.correo;
                document.getElementById("edit-tarifa").value = cliente.tarifaInicial;
                document.getElementById("edit-mensualidad").value = cliente.mensualidad;
                document.getElementById("edit-codigo").value = cliente.codigoPostal;
                document.getElementById("edit-plagas").value = cliente.plagasEncontradas;
                document.getElementById("edit-zona").value = cliente.zona;
            });
        }

        document.getElementById("logout").addEventListener("click", function () {
            localStorage.removeItem("token");
            window.location.href = "login.html";
        });

        document.getElementById("close-edit").addEventListener("click", function () {
            document.getElementById("edit-modal").classList.add("hidden");
        });

        cargarClientes();
    </script>

</body>
</html>
